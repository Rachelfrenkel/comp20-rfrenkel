<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="style.css">
		<script type="text/javascript"
			src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACyKO5dH-2eU_QZj5CTPv57CqvstqBXmE">
		</script>
		<script type="text/javascript">

			var usr = "MichaelCorner";
			var myLat = 0;
			var myLng = 0;
			var xhr = new XMLHttpRequest();
			var me = new google.maps.LatLng(myLat, myLng);
			var map;
			var marker;
			var places;
			var infowindow = new google.maps.InfoWindow();
			var myOptions = {
								zoom: 13, // The larger the zoom number, the bigger the zoom
								center: me,
							};
			
			window.onload = initData;

			function initData() {
				map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
				getMyCoords();
				mapAllMarkers();	
			}

			function mapAllMarkers() {

				xhr.open("POST", "http://chickenofthesea.herokuapp.com/sendLocation", true);
				xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

				xhr.onreadystatechange = function(){
					getMyCoords();
					console.log("got coords" + myLng);
					if (xhr.readyState === 4) {
						if (xhr.status === 200) {
							console.log("response is : " + xhr.responseText);
							var characters = xhr.responseText['characters'];
							var students   = xhr.responseText['students'];
							console.log("characters: " + characters);
							// mapCharacters(characters);
							// mapStudents(students);
							
						}
					}
				}
				xhr.send("login=" + usr + "&lat=" + myLat + "&lng=" + myLng);
			}

			function getMyCoords() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function(position) {
						myLat = position.coords.latitude;
						myLng = position.coords.longitude;
						initializeMap();
					})
				} else {
					alert("Geolocation is not supported by your web browser");
				}
			}
			
			function initializeMap() {

				me = new google.maps.LatLng(myLat, myLng);
				
				map.panTo(me);

				var mapOptions = {
					center: { lat: myLat, lng: myLng},
					zoom: 13
				};

				addMe(map);

				// addMarkers(map);

			};

			function addMe(map) {
				me = new google.maps.LatLng(myLat, myLng);
				var myIcon = 'images/' + usr + '.png';
				var mapIcon = new google.maps.MarkerImage(myIcon, null, null, null, 
														  new google.maps.Size(30, 50));
				marker = new google.maps.Marker({
					position: me,
					icon: mapIcon,
					map: map,
					title: usr
				});

				google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(marker.title);
					infowindow.open(map, marker);
				});
			}

			function mapCharacters(characters) {
				for (var i = 0; i < characters.length; i++) {
					var charName = characters[i]['name'];
					var charLat = characters[i]['loc']['latitude'];
					var charLng = characters[i]['loc']['longitude'];
					var charNote = characters[i]['loc']['note'];
					var charPos = new google.maps.LatLng(charLat, charLng);
					var charinfowindow = new google.maps.InfoWindow({
					  content: contentString
					});

					var charMarker = new google.maps.Marker({
						position: charPos,
						icon: charName + '.png',
						map: map,
					})

					var charText = '<h5>Name: ' + charName
								   + 'Latitude: ' + charLat 
								   + 'Longitude: ' + charLng
								   + 'Note: ' + charNote + '</h5>'

					google.maps.event.addListener(charMarker, 'click', function() {
						charinfowindow.setContent(charText);
						charinfowindow.open(map, charMarker);
					});
				}
			}

			function mapStudents(students) {

			}

      		function getDistance(lat1, lon1, lat2, lon2) {
				Number.prototype.toRad = function() {
				   return this * Math.PI / 180;
				}

				var R = 6371; // km 

				var x1 = lat2-lat1;
				var dLat = x1.toRad();  
				var x2 = lon2-lon1;
				var dLon = x2.toRad();  
				var a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
				                Math.cos(lat1.toRad()) * Math.cos(lat2.toRad()) * 
				                Math.sin(dLon/2) * Math.sin(dLon/2);  
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
				var d = R * c; 

				return d;
      		}

		

		</script>
	</head>
	<body>
		<div id="map-canvas"></div>
	</body>
</html>